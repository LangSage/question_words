<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Question Words Trainer ‚Äî Levels</title>
  <!-- Bootstrap 5.0.2 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <style>
    :root { --brand:#0d6efd; }
    body { background:#f8f9fa; }
    .card { border:none; box-shadow:0 6px 18px rgba(0,0,0,.06); border-radius:1rem; }
    .wchip {
      display:inline-block; padding:.25rem .5rem; border-radius:.5rem;
      background:#e9f2ff; color:#0b5ed7; font-weight:600; margin:.125rem;
    }
    .answer-pill { border-radius:.75rem; }
    .answer-pill.active { box-shadow:0 0 0 2px #0d6efd inset; }
    .star { font-size: 1.7rem; filter: drop-shadow(0 2px 3px rgba(0,0,0,.15)); }
    .star.on { color:#ffc107; }
    .level-btn { border-radius:.75rem; }
    .smallcaps { font-variant: all-small-caps; letter-spacing: .04em; }
  </style>
</head>
<body>
  <div class="container py-4 py-md-5">
    <header class="mb-4 text-center">
      <h1 class="h2 fw-bold mb-2">Question Words Trainer</h1>
      <p class="text-muted mb-0">
        Practice <span class="smallcaps">what / where / when / who / why / which / whose / how</span>
        (+ how much / how many / how often / how long / how far)
      </p>
    </header>

    <!-- Stats -->
    <div class="row g-3 mb-4">
      <div class="col-6 col-md-3">
        <div class="card p-3 text-center">
          <div class="small text-muted">Score</div>
          <div class="display-6" id="statScore">0</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card p-3 text-center">
          <div class="small text-muted">Streak</div>
          <div class="display-6" id="statStreak">0</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card p-3 text-center">
          <div class="small text-muted">Tasks</div>
          <div class="display-6" id="statTasks">0</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card p-3 text-center">
          <div class="small text-muted">Accuracy</div>
          <div class="display-6" id="statAcc">0%</div>
        </div>
      </div>
    </div>

    <!-- Levels -->
    <div class="card p-3 p-md-4 mb-4">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
        <div>
          <div class="small text-muted mb-1">Choose level</div>
          <div class="btn-group" role="group" aria-label="Levels">
            <button class="btn btn-primary level-btn" data-level="1">Level 1</button>
            <button class="btn btn-outline-primary level-btn" data-level="2">Level 2</button>
            <button class="btn btn-outline-primary level-btn" data-level="3">Level 3</button>
            <button class="btn btn-outline-primary level-btn" data-level="4">Level 4</button>
            <button class="btn btn-outline-primary level-btn" data-level="5">Level 5</button>
          </div>
        </div>
        <div class="text-end small text-muted">
          Tap an option ‚Üí Check ‚Üí Next.
        </div>
      </div>
    </div>

    <!-- Task Area -->
    <div id="area" class="mb-4"></div>

    <!-- Cheat Sheet -->
    <div class="card p-3 p-md-4">
      <div class="d-flex align-items-center justify-content-between">
        <h2 class="h5 mb-0">Cheat Sheet</h2>
        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#sheet">
          Show/Hide
        </button>
      </div>
      <div class="collapse show mt-3" id="sheet">
        <div class="mb-2">
          <span class="wchip">what ‚Äî —á—Ç–æ</span>
          <span class="wchip">where ‚Äî –≥–¥–µ</span>
          <span class="wchip">when ‚Äî –∫–æ–≥–¥–∞</span>
          <span class="wchip">who ‚Äî –∫—Ç–æ</span>
          <span class="wchip">why ‚Äî –ø–æ—á–µ–º—É</span>
          <span class="wchip">which ‚Äî –∫–∞–∫–æ–π/–∫–æ—Ç–æ—Ä—ã–π</span>
          <span class="wchip">whose ‚Äî —á–µ–π</span>
          <span class="wchip">how ‚Äî –∫–∞–∫</span>
          <span class="wchip">how much ‚Äî —Å–∫–æ–ª—å–∫–æ (–Ω–µ–∏—Å—á–∏—Å–ª.)</span>
          <span class="wchip">how many ‚Äî —Å–∫–æ–ª—å–∫–æ (–∏—Å—á–∏—Å–ª.)</span>
          <span class="wchip">how often ‚Äî –∫–∞–∫ —á–∞—Å—Ç–æ</span>
          <span class="wchip">how long ‚Äî –∫–∞–∫ –¥–æ–ª–≥–æ</span>
          <span class="wchip">how far ‚Äî –∫–∞–∫ –¥–∞–ª–µ–∫–æ</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Global audio element -->
  <audio id="audioWord" preload="auto"></audio>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
          crossorigin="anonymous"></script>
  <script>
    // ===== DATA =====
    const WORDS = [
      'what','where','when','who','why','which','whose','how',
      'how much','how many','how often','how long','how far'
    ];

    const FILL_BANK = [
      {b:"___ is your favorite subject?", a:"what", h:"specific information"},
      {b:"___ are you from?", a:"where", h:"place"},
      {b:"___ is your birthday?", a:"when", h:"time / date"},
      {b:"___ is standing at the door?", a:"who", h:"person"},
      {b:"___ are you late?", a:"why", h:"reason"},
      {b:"___ color do you prefer ‚Äî red or blue?", a:"which", h:"choice"},
      {b:"___ bag is this?", a:"whose", h:"possession"},
      {b:"___ do you come to college? By bus or on foot?", a:"how", h:"manner / method"},
      {b:"___ milk do we need for pancakes?", a:"how much", h:"quantity (uncountable)"},
      {b:"___ students are in your group?", a:"how many", h:"quantity (countable)"},
      {b:"___ do you travel? (every day / once a week)", a:"how often", h:"frequency"},
      {b:"___ is the lesson? (60 minutes)", a:"how long", h:"duration"},
      {b:"___ is your college from your house?", a:"how far", h:"distance"},
      {b:"At ___ time does the lesson start?", a:"what", h:"what time"},
      {b:"___ of these two options is cheaper?", a:"which", h:"limited set"},
      {b:"___ are you feeling today?", a:"how", h:"state / condition"},
      {b:"___ do you need this document?", a:"why", h:"reason"},
      {b:"___ city would you like to visit next?", a:"which", h:"choice"},
      {b:"___ is your best friend‚Äôs name?", a:"what", h:"specific information"},
      {b:"___ does the museum open on weekends?", a:"when", h:"time"}
    ];

    const MATCH_BANK = [
      {q:"Where do you study?", a:"In Pavlovsky Posad College."},
      {q:"When do you get up?", a:"At 7 a.m."},
      {q:"Who teaches you English?", a:"Mr. Andrey."},
      {q:"Why are you laughing?", a:"Because it‚Äôs funny!"},
      {q:"How many dogs do you have?", a:"Two."},
      {q:"How long is the film?", a:"About two hours."},
      {q:"How much water do you drink daily?", a:"Around two liters."},
      {q:"How far is the station?", a:"About 2 kilometers."},
      {q:"Whose jacket is this?", a:"It‚Äôs Lena‚Äôs."},
      {q:"Which color do you like more?", a:"Blue."},
      {q:"How often do you read books?", a:"Every evening."},
      {q:"What‚Äôs your dream job?", a:"Designer."}
    ];

    const SPEED_BANK = [
      {prompt:"(specific info) ____ is your name?", a:"what"},
      {prompt:"(place) ____ do you live?", a:"where"},
      {prompt:"(time) ____ do you arrive?", a:"when"},
      {prompt:"(person) ____ called you?", a:"who"},
      {prompt:"(reason) ____ are you late?", a:"why"},
      {prompt:"(choice) ____ color do you choose?", a:"which"},
      {prompt:"(possession) ____ book is this?", a:"whose"},
      {prompt:"(manner) ____ do you go to work?", a:"how"},
      {prompt:"(uncountable) ____ sugar do we need?", a:"how much"},
      {prompt:"(countable) ____ students were absent?", a:"how many"},
      {prompt:"(frequency) ____ do you clean the room?", a:"how often"},
      {prompt:"(duration) ____ is the break?", a:"how long"},
      {prompt:"(distance) ____ is the station?", a:"how far"}
    ];

    // LEVEL CONFIG
    const LEVELS = {
      1: {name: "Fill sentences (1)", type: "fill"},
      2: {name: "Fill sentences (2)", type: "fill"},
      3: {name: "Question ‚Üí answer", type: "qa"},
      4: {name: "Concept prompts (1)", type: "speed"},
      5: {name: "Concept prompts (2)", type: "speed"}
    };

    // ===== STATE =====
    let score = 0, streak = 0, tasks = 0, correctTotal = 0;
    let currentLevel = 1;
    let levelItems = [];    // unified MCQ items
    let idx = 0;
    let levelMistakes = 0;

    function shuffle(arr) {
      return arr.map(v => [Math.random(), v])
        .sort((a, b) => a[0] - b[0])
        .map(x => x[1]);
    }

    function updateStats() {
      document.getElementById('statScore').textContent = score;
      document.getElementById('statStreak').textContent = streak;
      document.getElementById('statTasks').textContent = tasks;
      const acc = tasks ? Math.round((correctTotal / tasks) * 100) : 0;
      document.getElementById('statAcc').textContent = acc + "%";
    }

    function starsFromMistakes(m) {
      if (m === 0) return 5;
      if (m <= 2) return 4;
      if (m <= 4) return 3;
      if (m <= 6) return 2;
      return 1;
    }

    function starHTML(n) {
      let out = "";
      for (let i = 1; i <= 5; i++) {
        out += `<span class="star ${i <= n ? 'on' : ''}">‚òÖ</span>`;
      }
      return out;
    }

    // ===== AUDIO HELPERS =====
    function wordToFilename(word) {
      // same logic as Python: spaces -> "_", lowercase
      return word.toLowerCase().replace(/\s+/g, "_") + ".mp3";
    }

    function playWordAudio(word) {
      const audio = document.getElementById("audioWord");
      if (!audio) return;
      const file = wordToFilename(word);
      audio.src = "audio/" + file;
      audio.play().catch(() => {
        console.warn("Audio not found:", audio.src);
      });
    }

    // Build items for a level into a unified format:
    // { question, hint, options[], correct, source }
    function buildLevelItems(levelNum) {
      const cfg = LEVELS[levelNum];
      const type = cfg.type;
      let items = [];

      if (type === "fill") {
        items = FILL_BANK.map(it => ({
          question: it.b.replace("___", "( ? )"),
          hint: it.h,
          correct: it.a,
          source: "fill"   // options from WORDS (6)
        }));
      } else if (type === "qa") {
        const allAnswers = MATCH_BANK.map(x => x.a);
        items = MATCH_BANK.map(it => {
          const distractors = shuffle(allAnswers.filter(a => a !== it.a)).slice(0, 3);
          const opts = shuffle([it.a, ...distractors]);
          return {
            question: it.q,
            hint: "",
            correct: it.a,
            options: opts,
            source: "qa"
          };
        });
      } else if (type === "speed") {
        items = SPEED_BANK.map(it => ({
          question: it.prompt,
          hint: "",
          correct: it.a,
          source: "speed"  // options from WORDS (4)
        }));
      }

      // Always max ‚Äî use all items, just shuffle them
      return shuffle(items);
    }

    function startLevel(levelNum) {
      currentLevel = levelNum;
      levelItems = buildLevelItems(levelNum);
      idx = 0;
      levelMistakes = 0;

      // buttons active style
      document.querySelectorAll(".level-btn").forEach(btn => {
        const active = +btn.dataset.level === levelNum;
        btn.classList.toggle("btn-primary", active);
        btn.classList.toggle("btn-outline-primary", !active);
      });

      renderQuestion();
    }

    function renderQuestion() {
      const item = levelItems[idx];
      let options = [];

      if (item.source === "fill") {
        // 6 options from WORDS
        options = shuffle(WORDS).slice(0, 6);
        if (!options.includes(item.correct)) {
          options[Math.floor(Math.random() * options.length)] = item.correct;
        }
      } else if (item.source === "speed") {
        // 4 options from WORDS
        options = shuffle(WORDS).slice(0, 4);
        if (!options.includes(item.correct)) {
          options[Math.floor(Math.random() * options.length)] = item.correct;
        }
      } else if (item.source === "qa") {
        options = item.options.slice();
      }

      const pills = options.map((opt, i) =>
        `<button class="btn btn-outline-primary answer-pill me-2 mb-2" data-opt="${opt}">
           ${i + 1}. ${opt}
         </button>`
      ).join("");

      const cfg = LEVELS[currentLevel];

      const rightHeader = item.hint
        ? `<span class="small text-muted">Hint: ${item.hint}</span>`
        : "";

      const html = `
        <div class="card p-3 p-md-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="small text-muted">
              Level ${currentLevel}: ${cfg.name} ‚Äî Question ${idx + 1}/${levelItems.length}
            </div>
            <div>${rightHeader}</div>
          </div>
          <h3 class="h5 mb-3">${item.question}</h3>
          <div id="options" class="mb-2">${pills}</div>
          <div class="d-grid d-md-flex gap-2 mt-2">
            <button id="btnCheck" class="btn btn-success" disabled>Check</button>
            <button id="btnNext" class="btn btn-outline-secondary" disabled>Next</button>
          </div>
          <div class="mt-3" id="feedback"></div>
        </div>
      `;

      const area = document.getElementById("area");
      area.innerHTML = html;

      let picked = null;
      const pillsEls = area.querySelectorAll(".answer-pill");
      const btnCheck = document.getElementById("btnCheck");
      const btnNext = document.getElementById("btnNext");
      const fb = document.getElementById("feedback");

      pillsEls.forEach(btn => {
        btn.addEventListener("click", () => {
          pillsEls.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          const opt = btn.dataset.opt;
          picked = opt;
          btnCheck.disabled = false;

          // üîä play audio when option is question word
          if (WORDS.includes(opt)) {
            playWordAudio(opt);
          }
        });
      });

      btnCheck.addEventListener("click", () => {
        if (!picked) return;
        const ok = picked === item.correct;
        tasks++;
        if (ok) {
          score += 8;
          streak++;
          correctTotal++;
          fb.innerHTML = `<div class="alert alert-success">‚úÖ Correct: <strong>${item.correct}</strong></div>`;
        } else {
          score = Math.max(0, score - 2);
          streak = 0;
          levelMistakes++;
          fb.innerHTML = `<div class="alert alert-danger">‚ùå Correct: <strong>${item.correct}</strong></div>`;
        }
        updateStats();
        btnCheck.disabled = true;
        btnNext.disabled = false;
      });

      btnNext.addEventListener("click", () => {
        if (idx < levelItems.length - 1) {
          idx++;
          renderQuestion();
        } else {
          endLevel();
        }
      });
    }

    function endLevel() {
      const stars = starsFromMistakes(levelMistakes);
      const acc = tasks ? Math.round((correctTotal / tasks) * 100) : 0;
      const title = levelMistakes === 0 ? "Perfect run!" : "Level complete";

      const html = `
        <div class="card p-4 text-center">
          <h3 class="h4 mb-2">${title} üéâ</h3>
          <div class="mb-2">${starHTML(stars)}</div>
          <p class="text-muted mb-1">
            Mistakes this level: <strong>${levelMistakes}</strong>
            ‚Ä¢ Global accuracy: <strong>${acc}%</strong>
            ‚Ä¢ Global score: <strong>${score}</strong>
          </p>
          <div class="d-grid d-md-flex justify-content-center gap-2 mt-2">
            <button class="btn btn-primary" id="again">Replay level ${currentLevel}</button>
            <button class="btn btn-outline-secondary" id="nextLvl">Next level</button>
            <button class="btn btn-outline-dark" id="review">Review questions</button>
          </div>
        </div>
      `;
      const area = document.getElementById("area");
      area.innerHTML = html;

      document.getElementById("again").onclick = () => startLevel(currentLevel);
      document.getElementById("nextLvl").onclick = () => startLevel(Math.min(5, currentLevel + 1));
      document.getElementById("review").onclick = reviewLast;
    }

    function reviewLast() {
      const list = levelItems.map((it, i) =>
        `<li class="list-group-item">
          ${i + 1}. ${it.question} ‚Äî <strong>${it.correct}</strong>
        </li>`
      ).join("");
      document.getElementById("area").innerHTML =
        `<div class="card p-3"><ol class="list-group list-group-numbered">${list}</ol></div>`;
    }

    // Level buttons
    document.querySelectorAll(".level-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const lv = +btn.dataset.level;
        startLevel(lv);
      });
    });

    function resetStats() {
      score = 0;
      streak = 0;
      tasks = 0;
      correctTotal = 0;
      updateStats();
    }

    // Init
    resetStats();
    startLevel(1);
  </script>
</body>
</html>
